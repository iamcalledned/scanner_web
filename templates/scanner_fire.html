<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FRCK642NXJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FRCK642NXJ');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fire Scanner Archive</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

<div class="max-w-4xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6 text-center">üî• Fire Scanner Call Archive</h1>
  <div class="flex justify-between items-center mb-4">
    <p class="text-sm text-gray-400">Total calls: {{ calls|length }}</p>
    <a href="/scanner_fire/archive" class="text-blue-400 hover:underline">View Archive &rarr;</a>
  </div>

  <div id="calls-container">
    {% for call in calls %}
    <div class="mb-6 p-4 rounded-xl bg-gray-800 shadow-md call-entry">
      <div class="text-sm text-gray-400 mb-1">{{ call.timestamp_human }} {{ call.feed }}</div>
      <audio class="w-full mb-2" controls src="{{ call.path }}"></audio>

      <div class="space-y-2">
        {% if call.edit_pending %}
          <div class="text-yellow-400 text-sm">‚úèÔ∏è Edit Pending</div>
          <pre class="whitespace-pre-wrap bg-yellow-800 p-3 rounded-md text-sm text-yellow-100 overflow-auto">{{ call.edited_transcript }}</pre>
          <div class="text-sm text-gray-400">Original Transcript:</div>
          <pre class="whitespace-pre-wrap bg-gray-700 p-3 rounded-md text-sm text-gray-300 overflow-auto">{{ call.transcript }}</pre>
        {% else %}
          <pre id="pre-{{ loop.index }}" class="whitespace-pre-wrap bg-gray-700 p-3 rounded-md text-sm text-gray-200 overflow-auto">{{ call.transcript }}</pre>
          <textarea id="edit-{{ loop.index }}" class="w-full bg-gray-800 text-sm p-3 rounded-md text-white border border-gray-600 hidden">{{ call.transcript }}</textarea>

          <div class="flex gap-2">
            <button onclick="enableEdit({{ loop.index }})" class="text-yellow-400 hover:underline text-sm">Edit</button>
            <button onclick="submitEdit('{{ call.file }}', '{{ call.feed }}', {{ loop.index }})" id="save-{{ loop.index }}" class="hidden text-green-400 hover:underline text-sm">Submit</button>
            <button onclick="cancelEdit({{ loop.index }})" id="cancel-{{ loop.index }}" class="hidden text-red-400 hover:underline text-sm">Cancel</button>
          </div>
          <div id="msg-{{ loop.index }}" class="text-green-400 text-sm hidden">‚úîÔ∏è Thank you for your submission!</div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <div id="loading-indicator" class="text-center text-gray-400 py-4 hidden">Loading more calls...</div>
  {% if not calls %}
  <p class="text-gray-400">No calls available yet. Check back soon.</p>
  {% endif %}
</div>

<script>
let loading = false;
let page = 1;
let moreCalls = true;

function isNearBottom() {
  return (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 200);
}

async function loadMoreCalls() {
  if (loading || !moreCalls || !isNearBottom()) return;
  loading = true;
  document.getElementById('loading-indicator').classList.remove('hidden');
  page += 1;

  const resp = await fetch(`/scanner_fire?page=${page}`, { headers: { Accept: 'application/json' } });
  if (resp.ok) {
    const data = await resp.json();
    if (data.calls && data.calls.length > 0) {
      const container = document.getElementById('calls-container');
      data.calls.forEach((call, i) => {
        const index = (page - 1) * 10 + i + 1;
        const div = document.createElement('div');
        div.className = 'mb-6 p-4 rounded-xl bg-gray-800 shadow-md call-entry';
        div.innerHTML = `
          <div class="text-sm text-gray-400 mb-1">${call.timestamp_human} ${call.feed || ''}</div>
          <audio class="w-full mb-2" controls src="${call.path}"></audio>
          <div class="space-y-2">
            ${call.edit_pending ? `
              <div class="text-yellow-400 text-sm">‚úèÔ∏è Edit Pending</div>
              <pre class="whitespace-pre-wrap bg-yellow-800 p-3 rounded-md text-sm text-yellow-100 overflow-auto">${call.edited_transcript}</pre>
              <div class="text-sm text-gray-400">Original Transcript:</div>
              <pre class="whitespace-pre-wrap bg-gray-700 p-3 rounded-md text-sm text-gray-300 overflow-auto">${call.transcript}</pre>
            ` : `
              <pre id="pre-${index}" class="whitespace-pre-wrap bg-gray-700 p-3 rounded-md text-sm text-gray-200 overflow-auto">${call.transcript}</pre>
              <textarea id="edit-${index}" class="w-full bg-gray-800 text-sm p-3 rounded-md text-white border border-gray-600 hidden">${call.transcript}</textarea>
              <div class="flex gap-2">
                <button onclick="enableEdit(${index})" class="text-yellow-400 hover:underline text-sm">Edit</button>
                <button onclick="submitEdit('${call.file}', '${call.feed}', ${index})" id="save-${index}" class="hidden text-green-400 hover:underline text-sm">Submit</button>
                <button onclick="cancelEdit(${index})" id="cancel-${index}" class="hidden text-red-400 hover:underline text-sm">Cancel</button>
              </div>
              <div id="msg-${index}" class="text-green-400 text-sm hidden">‚úîÔ∏è Thank you for your submission!</div>
            `}
          </div>
        `;
        container.appendChild(div);
      });
      if (data.calls.length < 10) moreCalls = false;
    } else {
      moreCalls = false;
    }
  }
  loading = false;
  document.getElementById('loading-indicator').classList.add('hidden');
}

function enableEdit(id) {
  document.getElementById(`pre-${id}`).classList.add("hidden");
  document.getElementById(`edit-${id}`).classList.remove("hidden");
  document.getElementById(`save-${id}`).classList.remove("hidden");
  document.getElementById(`cancel-${id}`).classList.remove("hidden");
  document.getElementById(`msg-${id}`).classList.add("hidden");
}

function cancelEdit(id) {
  const pre = document.getElementById(`pre-${id}`);
  const edit = document.getElementById(`edit-${id}`);
  edit.value = pre.innerText.trim();
  edit.classList.add("hidden");
  pre.classList.remove("hidden");
  document.getElementById(`save-${id}`).classList.add("hidden");
  document.getElementById(`cancel-${id}`).classList.add("hidden");
}

async function submitEdit(filename, feed, id) {
  const edited = document.getElementById(`edit-${id}`).value;
  const resp = await fetch("/scanner/submit_edit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ filename, feed, transcript: edited })
  });

  if (resp.ok) {
    document.getElementById(`save-${id}`).classList.add("hidden");
    document.getElementById(`cancel-${id}`).classList.add("hidden");
    document.getElementById(`edit-${id}`).classList.add("hidden");
    document.getElementById(`pre-${id}`).classList.remove("hidden");
    document.getElementById(`msg-${id}`).classList.remove("hidden");
  } else {
    alert("Submission failed.");
  }
}

window.addEventListener('scroll', loadMoreCalls);
window.addEventListener('touchmove', loadMoreCalls);
</script>

</body>
</html>
